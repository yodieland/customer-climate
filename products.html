<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CityCites - Products and Data</title>

    <!-- Include Bootstrap for styling -->
    <!-- jQuery CDN -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <!-- PapaParse CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Add these to your HTML head -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

<!-- Add these before closing body tag -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Include PapaParse for CSV parsing and jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
    /* General styling for body and typography */
/* General Styling */
/* Override Bootstrap's default font */
/* Global Typography */
body, h1, h2, h3, h4, h5, h6, p, a, button {
    font-family: 'Lato', sans-serif !important;
}

body {
    font-family: 'Lato', sans-serif !important;
    background-color: #f5f5f5 !important;
    color: #333 !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Navbar */
.custom-navbar {
    background-color: #2c3e50 !important;
    padding: 10px 0 !important;
}

.navbar-brand, .nav-link {
    color: #ecf0f1 !important;
    font-weight: 600 !important;
}

.nav-link:hover {
    color: #ff9636 !important;
}

/* Hero Section */
.hero {
    background: linear-gradient(to right, #ff9636, #e67e22) !important;
    color: #fff !important;
    padding: 60px 20px !important;
    text-align: center !important;
    position: relative !important;
    overflow: hidden !important;
}

.hero h1 {
    font-size: 2.5rem !important;
    font-weight: bold !important;
    animation: fadeIn 1.5s ease-in-out !important;
}

.hero p {
    font-size: 1.2rem !important;
    margin-top: 10px !important;
    animation: fadeIn 2s ease-in-out !important;
}

.hero::before {
    content: "" !important;
    position: absolute !important;
    top: -50px !important;
    left: -50px !important;
    width: 200px !important;
    height: 200px !important;
    background: rgba(255, 255, 255, 0.1) !important;
    border-radius: 50% !important;
    animation: floatAnimation 6s infinite alternate ease-in-out !important;
}

@keyframes floatAnimation {
    0% { transform: translate(0, 0) !important; }
    100% { transform: translate(30px, 30px) !important; }
}

/* Features Section */
.features {
    display: flex !important;
    justify-content: center !important;
    gap: 20px !important;
    margin: 40px auto !important;
    max-width: 1000px !important;
}

.feature-card {
    background: #fff !important;
    border-radius: 10px !important;
    padding: 20px !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1) !important;
    text-align: center !important;
    width: 250px !important;
    transition: transform 0.3s ease-in-out !important;
}

.feature-card:hover {
    transform: scale(1.05) !important;
}

.feature-card img {
    width: 50px !important;
    margin-bottom: 10px !important;
}

/* About Section */
.about-container {
    max-width: 1000px !important;
    margin: 50px auto !important;
    text-align: center !important;
}

.about-container h2 {
    color: #2c3e50 !important;
    font-size: 1.8rem !important;
    margin-bottom: 20px !important;
}

.about-container p {
    color: #7f8c8d !important;
    font-size: 1.1rem !important;
    line-height: 1.6 !important;
}

/* Footer */
.footer {
    background-color: #2c3e50 !important;
    color: #fff !important;
    text-align: center !important;
    padding: 20px !important;
}

/* Future Comparison Section */
#futureComparisonSection {
    margin: 20px auto !important;
    max-width: 1000px !important;
    font-family: 'Roboto', sans-serif !important;
}

#futureComparisonSection h2 {
    text-align: center !important;
    margin-bottom: 20px !important;
    font-weight: 400 !important;
}

/* Dropdown Styling */
#futureComparisonSection select {
    padding: 8px 12px !important;
    margin: 10px !important;
    border: 1px solid #ccc !important;
    border-radius: 4px !important;
    font-size: 14px !important;
}

/* Table Styling */
#futureComparisonTable {
    width: 100% !important;
    border-collapse: collapse !important;
    margin-top: 20px !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
}

#futureComparisonTable th, 
#futureComparisonTable td {
    padding: 12px 15px !important;
    border: 1px solid #ddd !important;
    text-align: center !important;
    font-size: 14px !important;
}

#futureComparisonTable th {
    background-color: #007bff !important;
    color: #fff !important;
    font-weight: 600 !important;
}

#futureComparisonTable thead tr:nth-child(2) th {
    background-color: #0056b3 !important;
}

#futureComparisonTable tbody tr:nth-child(even) {
    background-color: #f9f9f9 !important;
}

#futureComparisonTable tbody tr:hover {
    background-color: #f1f1f1 !important;
}


  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg custom-navbar">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="Picture2.png" alt="Welcome" style="height: 40px;">
    </a>
        <button class="navbar-toggler" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
<li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>

<!-- Dropdown for Offerings -->
<li class="nav-item dropdown">
  <a class="nav-link dropdown-toggle" href="products.html" id="offeringsDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Products
  </a>
  <ul class="dropdown-menu" aria-labelledby="offeringsDropdown">
    <li><a class="dropdown-item" href="#comparisonTable">Basic</a></li>
    <li><a class="dropdown-item" href="#premium">Premium</a></li>
    <li><a class="dropdown-item" href="#customreport">Custom</a></li>
  </ul>
</li>
</ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item ms-4"><a class="nav-link" href="login.html">Login</a></li>
          <li class="nav-item ms-4"><a class="nav-link" href="signup.html">Sign Up</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Product Section -->
  <!-- in your <head> or App.css -->
<style>
.product-image {
  width: 100%;
  height: 200px;
  object-fit: cover;
}
</style>

<!-- in your body -->
<div class="container product-container">
  <h1 class="text-center">Our Products</h1>
  <div class="row">
    <!-- Product 1 -->
    <div class="col-md-4 d-flex">
      <div class="card flex-fill">
        <img src="choong-deng-xiang--WXQm_NTK0U-unsplash.jpg"
             alt="Product 1" class="card-img-top product-image">
        <div class="card-body d-flex flex-column">
          <h4 class="card-title">City Pulse©</h4>
          <h6 class="card-title">City Data, Metrics & CityCites Score©</h6>
          <p class="card-text flex-grow-1">
            Lookup your city scores, other salient data and metrics…
          </p>
          <a href="#CDED" class="btn btn-primary mt-auto">Learn More</a>
        </div>
      </div>
    </div>

    <!-- Product 2 -->
    <div class="col-md-4 d-flex">
      <div class="card flex-fill">
        <img src="towfiqu-barbhuiya-nApaSgkzaxg-unsplash.jpg"
             alt="Product 2" class="card-img-top product-image">
        <div class="card-body d-flex flex-column">
          <h4 class="card-title">City Sense©</h4>
          <h6 class="card-title">Comparative Metrics & Predictive Analytics</h6>
          <p class="card-text flex-grow-1">
            Get an instant report that includes comparison data & predictive analytics.
          </p>
          <a href="#Compare" class="btn btn-primary mt-auto">Learn More</a>
        </div>
      </div>
    </div>

    <!-- Product 3 -->
    <div class="col-md-4 d-flex">
      <div class="card flex-fill">
        <img src="campaign-creators-pypeCEaJeZY-unsplash.jpg"
             alt="Product 3" class="card-img-top product-image">
        <div class="card-body d-flex flex-column">
          <h4 class="card-title">City Insites©</h4>
          <h6 class="card-title">Customize Your Data</h6>
          <p class="card-text flex-grow-1">
            Create fiscal efficiencies in your organization…
          </p>
          <a href="#Insights" class="btn btn-primary mt-auto">Learn More</a>
        </div>
      </div>
    </div>
  </div>
</div>

  <br>
  <br>

  <title>City Metrics Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
      .section-spacing {
          margin-bottom: 3rem;
      }
      .table-container {
          margin-top: 2rem;
          margin-bottom: 2rem;
      }
      .form-spacing {
          margin-bottom: 1.5rem;
      }
      .button-spacing {
          margin-right: 1rem;
          margin-bottom: 1rem;
      }
      .embed-responsive {
          margin-top: 2rem;
          margin-bottom: 2rem;
      }
      .custom-report {
          margin-top: 3rem;
      }
  </style>
</head>
<body>
  <div class="container">
      <!-- City Score Dashboards -->
      <div class="section-spacing">
          <h1>City Score Dashboards</h1>
          <p>Pick your favorite city to see how the scores stack up! Using a proprietary algorthim, we have calculated linear and logorithmic scores.</p>
          <a href="https://scores-pzfpg93bqyylpfdpkepvgo.streamlit.app/" target="_blank">
              <button class="btn btn-primary button-spacing">Linear Scores</button>
          </a>
          <a href="https://logscores-iixxfoyabyahjz9vo8dcph.streamlit.app/" target="_blank">
              <button class="btn btn-primary button-spacing">Log Scores</button>
          </a>
         
      </div>

      <!-- City Demographics and Economic Data -->
      <div class="section-spacing">
          <h2 id ="CDED">City Demographics and Economic Data</h2>
          <div class="form-spacing">
              <label>Select Year:</label>
              <select id="yearDropdown" class="form-select mb-3">
                  <option value="" disabled selected>Year</option>
                  <option value="2018">2018</option>
                  <option value="2019">2019</option>
                  <option value="2021">2021</option>
                  <option value="2022">2022</option>
              </select>
          </div>
          <div class="form-spacing">
              <label>Select City:</label>
              <select id="cityDropdown" class="form-select mb-3" disabled>
                  <option value="" disabled selected>City</option>
              </select>
          </div>
          <div class="form-spacing">
              <label>Filter by Category:</label>
              <div class="form-check">
                  <input type="checkbox" class="form-check-input category-filter" value="Social"> Social
              </div>
              <div class="form-check">
                  <input type="checkbox" class="form-check-input category-filter" value="Economic"> Economic
              </div>
              <div class="form-check">
                  <input type="checkbox" class="form-check-input category-filter" value="Political"> Political
              </div>
              <div class="form-check">
                  <input type="checkbox" class="form-check-input category-filter" value="Environmental"> Environmental
              </div>
          </div>
          <button id="filterBtn" class="btn btn-primary mt-3">Apply Filters</button>
          <table id="cityMetricsTable" class="table table-bordered table-striped mt-4">
              <thead id="cityMetricsTableHeader"></thead>
              <tbody id="cityMetricsTableBody"></tbody>
          </table>
      </div>

      <!-- City Comparison Section -->
      <div class="section-spacing">
          <h2 id = "Compare">Compare Two Cities</h2>
          <p>Compare relavent metrics of two of your favorite cities</p>
          <div class="form-spacing">
              <label for="csvDropdown">Select Data Type & Year:</label>
              <select id="csvDropdown" class="form-control mb-3">
                  <optgroup label="Metrics Tables">
                      <option value="metrics-2018">Metrics Table - 2018</option>
                      <option value="metrics-2019">Metrics Table - 2019</option>
                      <option value="metrics-2021">Metrics Table - 2021</option>
                      <option value="metrics-2022">Metrics Table - 2022</option>
                  </optgroup>
                  <optgroup label="Data Points Tables">
                      <option value="data-2018">Data Points Table - 2018</option>
                      <option value="data-2019">Data Points Table - 2019</option>
                      <option value="data-2021">Data Points Table - 2021</option>
                      <option value="data-2022">Data Points Table - 2022</option>
                  </optgroup>
              </select>
          </div>
          <div class="row mb-3">
              <div class="col-md-6">
                  <label for="city1Dropdown">Select First City:</label>
                  <select id="city1Dropdown" class="form-control">
                      <option value="">Select City 1</option>
                  </select>
              </div>
              <div class="col-md-6">
                  <label for="city2Dropdown">Select Second City:</label>
                  <select id="city2Dropdown" class="form-control">
                      <option value="">Select City 2</option>
                  </select>
              </div>
          </div>
          <table id="comparisonTable" class="table table-bordered table-striped">
              <thead id="comparisonTableHeader"></thead>
              <tbody id="comparisonTableBody"></tbody>
          </table>
      </div>
      
      <div class="section-spacing">
        <h2>City Metrics Trend</h2>
        <div class="form-spacing">
            <label for="cityTrendDropdown">Look up metric trends over the past several years</label>
            <select id="cityTrendDropdown" class="form-control mb-3">
                <option value="">Select City</option>
            </select>
        </div>
        <table id="metricsTable" class="table table-bordered table-striped">
            <thead id="metricsTableHeader"></thead>
            <tbody id="metricsTableBody"></tbody>
        </table>
    </div>
      <!-- Future Metrics Comparison -->
      <div class="section-spacing">
          <h2>Metrics Trend Comparison (2023-2026)</h2>
          <p>Compare city trends over several years</p>
          <div class="form-spacing">
              <label for="futureCity1Dropdown">City 1:</label>
              <select id="futureCity1Dropdown" class="form-control"></select>
          </div>
          <div class="form-spacing">
              <label for="futureCity2Dropdown">City 2:</label>
              <select id="futureCity2Dropdown" class="form-control"></select>
          </div>
          <table id="futureComparisonTable" class="table table-bordered table-striped">
              <thead id="futureComparisonTableHeader"></thead>
              <tbody id="futureComparisonTableBody"></tbody>
          </table>
      </div>

      <!-- City Metrics Trend Section -->
     

      <!-- Custom Reports -->
     
      <!-- Add these to your head section -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
<h2 id = "Insights">City Insites©</h2>
    <p>City Insites© provides a quick snapshot of the fiscal markers in a particular time frame for a given city. Cities can instantly compare financial data with 1000s of cities in their cohorts to identify gaps as a first step to building efficiencies in their budgeting ststems. of peer  </p>
<!-- Your table containers -->
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="table-container">
                <h2>City Metrics</h2>
                <select id="sheet2Select"></select>
                <table id="sheet2Table" class="display" style="width:100%"></table>
            </div>
            
            <div class="table-container">
                <h2>City Data</h2>
                <select id="citySelect1"></select>
                <table id="rawDataTable" class="display" style="width:100%"></table>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="table-container">
                <h2>Financial InSights</h2>
                <p>Get an instant snapshot of how your city budget elements stack up, and discover gaps to help create financial efficiencies. Our proprietary algorithm computes the ideal reference city budget from 1000s of cities within your cohort for meanigful insights. </p>
                <select id="citySelect2"></select>
                <table id="percentageDataTable" class="display" style="width:100%"></table>
            </div>
            
            <div class="table-container">
                <h2>Placemaking</h2>
                <p>Use the CityCites© tool to help improve Placemeking for your city. Identify gaps, build efficiencies by undersatnding where to approprite funding for best outcomes. Our proprietary algorithm computes and compares Placemaking expenditures with an ideal reference city derived from 1000s of cities in your cohort (amount in USD). </p>
                <select id="citySelect3"></select>
                <table id="placemakingTable" class="display" style="width:100%"></table>
            </div>
        </div>
    </div>
</div>

<!-- Add these before closing body tag -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
      <!-- City Insights -->
      <!-- City Insights Section -->


<br>

<style>
    .priority-row {
        background-color: #f8f9fa !important;
        font-weight: 600 !important;
    }
    .priority-row td:first-child {
        border-left: 3px solid #007bff !important;
        color: #0056b3 !important;
    }
    
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.7);
        display: none;
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .toast {
        display: none;
        padding: 12px 20px;
        margin: 10px;
        border-radius: 4px;
        color: white;
    }
    .toast-info { background: #17a2b8; }
    .toast-success { background: #28a745; }
    .toast-warning { background: #ffc107; color: #212529; }
    .toast-error { background: #dc3545; }
    
    #dataFreshness {
        font-size: 0.8em;
        color: #6c757d;
        display: none;
        margin-left: 10px;
    }
    
    select.form-control {
        max-width: 300px;
        margin-bottom: 10px;
    }
</style>
<!-- Example: Place this snippet in your HTML where you want the Custom Placemaking form to appear -->
<div class="row">
    <!-- Left column: Placemaking Table (existing element) -->
    <div class="col-md-6">
      <!-- Assume your placemaking table is rendered here -->
      <div id="placemakingTableContainer">
        <!-- Placemaking table placeholder -->
        <h4>Placemaking Comparison</h4>
        <table id="placemakingTable" class="table table-striped table-bordered"></table>
      </div>
    </div>
    
    <!-- Right column: Custom Placemaking Form -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>Custom Placemaking</h5>
        </div>
        <div class="card-body">
          <form id="customPlacemakingForm">
            <div class="row">
              <!-- Per Person Metrics -->
              <div class="col-md-6">
                <h6>Per Person Metrics</h6>
                <div class="form-group">
                  <label>Public Safety per Person</label>
                  <input type="number" class="form-control" name="Custom Public Safety per Person" step="0.01">
                </div>
                <div class="form-group">
                  <label>Public Works per Person</label>
                  <input type="number" class="form-control" name="Custom Public Works per Person" step="0.01">
                </div>
                <div class="form-group">
                  <label>Parks & Rec. per Person</label>
                  <input type="number" class="form-control" name="Custom Parks & Rec. per Person" step="0.01">
                </div>
                <div class="form-group">
                  <label>Comm. & Econ. Dev. per Person</label>
                  <input type="number" class="form-control" name="Custom Comm. & Econ. Dev. per Person" step="0.01">
                </div>
                <div class="form-group">
                  <label>Public Health per Person</label>
                  <input type="number" class="form-control" name="Custom Public Health per Person" step="0.01">
                </div>
                <div class="form-group">
                  <label>Revenue per Person</label>
                  <input type="number" class="form-control" name="Custom Revenue per Person" step="0.01">
                </div>
              </div>
              <!-- Total Metrics -->
              <div class="col-md-6">
                <h6>Total Metrics</h6>
                <div class="form-group">
                  <label>Public Safety</label>
                  <input type="number" class="form-control" name="Custom Public Safety" step="0.01">
                </div>
                <div class="form-group">
                  <label>Public Works</label>
                  <input type="number" class="form-control" name="Custom Public Works" step="0.01">
                </div>
                <div class="form-group">
                  <label>Parks & Rec.</label>
                  <input type="number" class="form-control" name="Custom Parks & Rec." step="0.01">
                </div>
                <div class="form-group">
                  <label>Comm. & Econ. Dev.</label>
                  <input type="number" class="form-control" name="Custom Comm. & Econ. Dev." step="0.01">
                </div>
                <div class="form-group">
                  <label>Public Health</label>
                  <input type="number" class="form-control" name="Custom Public Health" step="0.01">
                </div>
                <div class="form-group">
                  <label>Revenue</label>
                  <input type="number" class="form-control" name="Custom Revenue" step="0.01">
                </div>
              </div>
            </div>
            <!-- A button to indicate that this product feature is coming soon -->
            <div class="text-right">
              <button type="button" class="btn btn-primary" disabled>Coming Soon</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <script>
   $(document).ready(function () {
    let allMetricsData = {};
    let allDataPointsData = {};
    let categoryMap = {};  // Stores categories for filtering

    function loadAllCSVs() {
        const metricsUrls = {
            "2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202018.csv",
            "2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202019.csv",
            "2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202021.csv",
            "2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202022.csv"
        };

        const dataPointsUrls = {
            "2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202018.csv",
            "2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202019.csv",
            "2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202021.csv",
            "2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202022.csv"
        };

        const promises = [];

        // Load Metrics Data
        Object.keys(metricsUrls).forEach(year => {
            promises.push(new Promise((resolve, reject) => {
                Papa.parse(metricsUrls[year], {
                    download: true,
                    header: true,
                    complete: function(results) {
                        allMetricsData[year] = results.data;
                        extractCategoryMapping(results.data);
                        resolve();
                    },
                    error: function(error) {
                        console.error("Error loading metrics CSV:", error);
                        reject();
                    }
                });
            }));
        });

        // Load Data Points
        Object.keys(dataPointsUrls).forEach(year => {
            promises.push(new Promise((resolve, reject) => {
                Papa.parse(dataPointsUrls[year], {
                    download: true,
                    header: true,
                    complete: function(results) {
                        allDataPointsData[year] = results.data;
                        resolve();
                    },
                    error: function(error) {
                        console.error("Error loading data points CSV:", error);
                        reject();
                    }
                });
            }));
        });

        Promise.all(promises).then(() => {
            console.log("All data loaded successfully!");
            populateCityDropdown();
        });
    }

    function extractCategoryMapping(data) {
        // Check if a "CATEGORY" row exists
        const categoryRowIndex = data.findIndex(row => Object.values(row).includes("CATEGORY"));
        if (categoryRowIndex !== -1) {
            const headers = Object.keys(data[0]);
            const categoryRow = data[categoryRowIndex];

            headers.forEach(header => {
                categoryMap[header] = categoryRow[header] || "Uncategorized";
            });
        }
    }

    function populateCityDropdown() {
        const cityDropdown = $('#cityDropdown');
        let cityNames = new Set();

        Object.keys(allMetricsData).forEach(year => {
            allMetricsData[year].forEach(row => cityNames.add(row.CITY));
        });

        cityDropdown.empty().append('<option value="" disabled selected>Select a city</option>');
        cityNames.forEach(city => cityDropdown.append(`<option value="${city}">${city}</option>`));
        cityDropdown.prop("disabled", false);
    }

    $("#yearDropdown, #cityDropdown").on("change", function () {
        const selectedYear = $("#yearDropdown").val();
        const selectedCity = $("#cityDropdown").val();
        if (selectedYear && selectedCity) {
            showCityData(selectedYear, selectedCity);
        }
    });

    function showCityData(year, cityName) {
        console.log("Fetching data for:", cityName, "in", year);

        const cityMetricsTableHeader = $('#cityMetricsTableHeader');
        const cityMetricsTableBody = $('#cityMetricsTableBody');

        cityMetricsTableHeader.empty();
        cityMetricsTableBody.empty();

        const cityMetricsData = allMetricsData[year]?.find(row => row.CITY === cityName);
        const cityDataPointsData = allDataPointsData[year]?.find(row => row.CITY === cityName);

        if (cityMetricsData && cityDataPointsData) {
            const headersMetrics = Object.keys(cityMetricsData);
            const headersDataPoints = Object.keys(cityDataPointsData);

            // Get selected category filters
            const selectedCategories = $(".category-filter:checked").map((_, el) => el.value.toLowerCase()).get();

            const headerRow = $('<tr></tr>');
            headerRow.append('<th>Metric</th><th>Value</th><th>Data Point</th><th>Value</th>');
            cityMetricsTableHeader.append(headerRow);

            headersMetrics.forEach((header, index) => {
                if (header !== "CITY" && header !== "year") {
                    // Check if the metric belongs to the selected category
                    if (selectedCategories.length === 0 || selectedCategories.includes(categoryMap[header]?.toLowerCase())) {
                        const rowElement = $('<tr></tr>');
                        rowElement.append(`<td>${header}</td>`);
                        rowElement.append(`<td>${cityMetricsData[header] || 'N/A'}</td>`);
                        rowElement.append(`<td>${headersDataPoints[index] || 'N/A'}</td>`);
                        rowElement.append(`<td>${cityDataPointsData[headersDataPoints[index]] || 'N/A'}</td>`);
                        cityMetricsTableBody.append(rowElement);
                    }
                }
            });
        } else {
            cityMetricsTableBody.append('<tr><td colspan="4">No data available for this city and year.</td></tr>');
        }
    }

    $("#filterBtn").on("click", function () {
        const selectedYear = $("#yearDropdown").val();
        const selectedCity = $("#cityDropdown").val();
        if (selectedYear && selectedCity) {
            showCityData(selectedYear, selectedCity);
        }
    });

    loadAllCSVs();
});


    </script>
<script>
  $(document).ready(function () {
    let originalData = []; // ✅ Define globally so it can be accessed anywhere

    const csvUrls = {
        "metrics-2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202018.csv",
        "metrics-2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202019.csv",
        "metrics-2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202021.csv",
        "metrics-2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202022.csv",
        "data-2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202018.csv",
        "data-2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202019.csv",
        "data-2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202021.csv",
        "data-2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202022.csv"
    };

    function loadCSV(type) {
        if (!csvUrls[type]) {
            console.error("No CSV URL found for selected type.");
            return;
        }

        Papa.parse(csvUrls[type], {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                if (!results.data || results.data.length === 0) {
                    console.error("No data found in CSV.");
                    return;
                }
                originalData = results.data; // ✅ Now originalData is properly assigned
                console.log("Loaded data:", originalData); // Debugging step
                populateCityDropdowns(originalData);
            },
            error: function (error) {
                console.error("Failed to load CSV:", error);
            }
        });
    }

    function populateCityDropdowns(data) {
        const city1Dropdown = $('#city1Dropdown');
        const city2Dropdown = $('#city2Dropdown');
        city1Dropdown.empty();
        city2Dropdown.empty();

        city1Dropdown.append('<option value="">Select City 1</option>');
        city2Dropdown.append('<option value="">Select City 2</option>');

        const cities = [...new Set(data.map(row => row.CITY?.trim()).filter(Boolean))].sort();
        if (cities.length === 0) {
            console.warn("No cities found in dataset.");
        }

        cities.forEach(city => {
            city1Dropdown.append(`<option value="${city}">${city}</option>`);
            city2Dropdown.append(`<option value="${city}">${city}</option>`);
        });
    }

    function compareCities() {
        if (!originalData || originalData.length === 0) {
            console.error("originalData is empty or not loaded yet.");
            return;
        }

        const city1 = $('#city1Dropdown').val();
        const city2 = $('#city2Dropdown').val();
        if (!city1 || !city2) {
            console.warn("Please select both cities.");
            return;
        }

        const city1Data = originalData.find(row => row.CITY === city1);
        const city2Data = originalData.find(row => row.CITY === city2);

        if (!city1Data || !city2Data) {
            console.error("City data not found.");
            return;
        }

        buildComparisonTable(city1Data, city2Data);
    }

    function buildComparisonTable(city1Data, city2Data) {
        const comparisonTableHeader = $('#comparisonTableHeader');
        const comparisonTableBody = $('#comparisonTableBody');

        // Clear previous content
        comparisonTableHeader.empty();
        comparisonTableBody.empty();

        if (!city1Data || !city2Data) {
            console.warn("City data missing for one or both cities.");
            return;
        }

        // Extract headers (excluding "CITY")
        const headers = Object.keys(city1Data).filter(header => header !== "CITY");

        let headerRow = `<tr><th>Metrics</th><th>${city1Data.CITY}</th><th>${city2Data.CITY}</th></tr>`;
        comparisonTableHeader.append(headerRow);

        headers.forEach(header => {
            let row = `<tr>
                <td>${header}</td>
                <td>${city1Data[header] || 'N/A'}</td>
                <td>${city2Data[header] || 'N/A'}</td>
            </tr>`;
            comparisonTableBody.append(row);
        });
    }

    $('#csvDropdown').on('change', function () {
        loadCSV($(this).val());
    });

    $('#city1Dropdown, #city2Dropdown').on('change', function () {
        compareCities();
    });

    loadCSV($('#csvDropdown').val()); // ✅ Load initial dataset when the page loads
});

    
</script>



<script>
  $(document).ready(function () {
    let originalData = []; // ✅ Define globally so it can be accessed anywhere

    const csvUrls = {
        "metrics-2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202018.csv",
        "metrics-2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202019.csv",
        "metrics-2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202021.csv",
        "metrics-2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202022.csv",
        "data-2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202018.csv",
        "data-2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202019.csv",
        "data-2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202021.csv",
        "data-2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202022.csv"
    };

    function loadCSV(type) {
        if (!csvUrls[type]) {
            console.error("No CSV URL found for selected type.");
            return;
        }

        Papa.parse(csvUrls[type], {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function (results) {
                if (!results.data || results.data.length === 0) {
                    console.error("No data found in CSV.");
                    return;
                }
                originalData = results.data; // ✅ Now originalData is properly assigned
                console.log("Loaded data:", originalData); // Debugging step
                populateCityDropdowns(originalData);
            },
            error: function (error) {
                console.error("Failed to load CSV:", error);
            }
        });
    }

    function populateCityDropdowns(data) {
        const city1Dropdown = $('#city1Dropdown');
        const city2Dropdown = $('#city2Dropdown');
        city1Dropdown.empty();
        city2Dropdown.empty();

        city1Dropdown.append('<option value="">Select City 1</option>');
        city2Dropdown.append('<option value="">Select City 2</option>');

        const cities = [...new Set(data.map(row => row.CITY?.trim()).filter(Boolean))].sort();
        if (cities.length === 0) {
            console.warn("No cities found in dataset.");
        }

        cities.forEach(city => {
            city1Dropdown.append(`<option value="${city}">${city}</option>`);
            city2Dropdown.append(`<option value="${city}">${city}</option>`);
        });
    }

    function compareCities() {
        if (!originalData || originalData.length === 0) {
            console.error("originalData is empty or not loaded yet.");
            return;
        }

        const city1 = $('#city1Dropdown').val();
        const city2 = $('#city2Dropdown').val();
        if (!city1 || !city2) {
            console.warn("Please select both cities.");
            return;
        }

        const city1Data = originalData.find(row => row.CITY === city1);
        const city2Data = originalData.find(row => row.CITY === city2);

        if (!city1Data || !city2Data) {
            console.error("City data not found.");
            return;
        }

        buildComparisonTable(city1Data, city2Data);
    }

    function buildComparisonTable(city1Data, city2Data) {
        const comparisonTableHeader = $('#comparisonTableHeader');
        const comparisonTableBody = $('#comparisonTableBody');

        // Clear previous content
        comparisonTableHeader.empty();
        comparisonTableBody.empty();

        if (!city1Data || !city2Data) {
            console.warn("City data missing for one or both cities.");
            return;
        }

        // Extract headers (excluding "CITY")
        const headers = Object.keys(city1Data).filter(header => header !== "CITY");

        let headerRow = `<tr><th>Metrics</th><th>${city1Data.CITY}</th><th>${city2Data.CITY}</th></tr>`;
        comparisonTableHeader.append(headerRow);

        headers.forEach(header => {
            let row = `<tr>
                <td>${header}</td>
                <td>${city1Data[header] || 'N/A'}</td>
                <td>${city2Data[header] || 'N/A'}</td>
            </tr>`;
            comparisonTableBody.append(row);
        });
    }

    $('#csvDropdown').on('change', function () {
        loadCSV($(this).val());
    });

    $('#city1Dropdown, #city2Dropdown').on('change', function () {
        compareCities();
    });

    loadCSV($('#csvDropdown').val()); // ✅ Load initial dataset when the page loads
});


</script>
<script>
  $(document).ready(function () {
      let allMetricsData = {};
      let allDataPointsData = {};
  
      function loadAllCSVs() {
          const metricsUrls = {
              "2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202018.csv",
              "2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202019.csv",
              "2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202021.csv",
              "2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/metrics%20table%20-%202022.csv"
          };
  
          const dataPointsUrls = {
              "2018": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202018.csv",
              "2019": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202019.csv",
              "2021": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202021.csv",
              "2022": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/data%20points%20table%20-%202022.csv"
          };
  
          const promises = [];
  
          // Load Metrics Data
          Object.keys(metricsUrls).forEach(year => {
              promises.push(new Promise((resolve, reject) => {
                  Papa.parse(metricsUrls[year], {
                      download: true,
                      header: true,
                      complete: function (results) {
                          allMetricsData[year] = results.data;
                          console.log(`✅ Loaded metrics data for ${year}:`, results.data);
                          resolve();
                      },
                      error: function (error) {
                          console.error(`❌ Error loading metrics CSV (${year}):`, error);
                          reject();
                      }
                  });
              }));
          });
  
          // Load Data Points
          Object.keys(dataPointsUrls).forEach(year => {
              promises.push(new Promise((resolve, reject) => {
                  Papa.parse(dataPointsUrls[year], {
                      download: true,
                      header: true,
                      complete: function (results) {
                          allDataPointsData[year] = results.data;
                          console.log(`✅ Loaded data points for ${year}:`, results.data);
                          resolve();
                      },
                      error: function (error) {
                          console.error(`❌ Error loading data points CSV (${year}):`, error);
                          reject();
                      }
                  });
              }));
          });
  
          Promise.all(promises).then(() => {
              console.log("✅ All data loaded successfully!");
              populateCityTrendDropdown();
          }).catch(error => console.error("❌ Error loading CSV files:", error));
      }
  
      function populateCityTrendDropdown() {
          const cityTrendDropdown = $('#cityTrendDropdown');
          const cityNames = new Set();
  
          // Collect unique city names from all years
          Object.keys(allMetricsData).forEach(year => {
              allMetricsData[year].forEach(row => {
                  if (row.CITY || row.City) cityNames.add(row.CITY || row.City);
              });
          });
  
          Object.keys(allDataPointsData).forEach(year => {
              allDataPointsData[year].forEach(row => {
                  if (row.CITY || row.City) cityNames.add(row.CITY || row.City);
              });
          });
  
          // Populate dropdown
          cityTrendDropdown.empty().append('<option value="">Select a City</option>');
          cityNames.forEach(city => {
              cityTrendDropdown.append(`<option value="${city}">${city}</option>`);
          });
      }
  
      // Event listener for city selection
      $('#cityTrendDropdown').on('change', function () {
          const selectedCity = $(this).val();
          if (selectedCity) {
              showCityTrend(selectedCity);
          } else {
              $('#metricsTableHeader, #metricsTableBody, #dataPointsTableHeader, #dataPointsTableBody').empty();
          }
      });
  
      function showCityTrend(cityName) {
          console.log("Fetching trend for:", cityName);
  
          const metricsTableHeader = $('#metricsTableHeader');
          const metricsTableBody = $('#metricsTableBody');
          const dataPointsTableHeader = $('#dataPointsTableHeader');
          const dataPointsTableBody = $('#dataPointsTableBody');
  
          metricsTableHeader.empty();
          metricsTableBody.empty();
          dataPointsTableHeader.empty();
          dataPointsTableBody.empty();
  
          const cityDataMetrics = [];
          const cityDataPoints = [];
  
          // Get Metrics Data for the selected city
          Object.keys(allMetricsData).forEach(year => {
              const cityYearData = allMetricsData[year].find(row => row.CITY === cityName || row.City === cityName);
              if (cityYearData) {
                  cityDataMetrics.push({ ...cityYearData, year });
              }
          });
  
          // Get Data Points for the selected city
          Object.keys(allDataPointsData).forEach(year => {
              const cityYearData = allDataPointsData[year].find(row => row.CITY === cityName || row.City === cityName);
              if (cityYearData) {
                  cityDataPoints.push({ ...cityYearData, year });
              }
          });
  
          console.log("📊 City Metrics Data: ", cityDataMetrics);
          console.log("📊 City Data Points: ", cityDataPoints);
  
          if (cityDataMetrics.length > 0) {
              const headersMetrics = Object.keys(cityDataMetrics[0]).filter(header => header !== 'year' && header !== 'CITY');
  
              const headerRow = $('<tr></tr>');
              headerRow.append('<th>Year</th>');
              headersMetrics.forEach(header => {
                  headerRow.append(`<th>${header}</th>`);
              });
              metricsTableHeader.append(headerRow);
  
              cityDataMetrics.forEach(row => {
                  const rowElement = $('<tr></tr>');
                  rowElement.append(`<td>${row.year}</td>`);
  
                  headersMetrics.forEach(header => {
                      rowElement.append(`<td>${row[header] || 'N/A'}</td>`);
                  });
  
                  metricsTableBody.append(rowElement);
              });
          } else {
              metricsTableBody.append('<tr><td colspan="100%">No data available for this city.</td></tr>');
          }
  
          if (cityDataPoints.length > 0) {
              const headersDataPoints = Object.keys(cityDataPoints[0]).filter(header => header !== 'year' && header !== 'CITY');
  
              const headerRow = $('<tr></tr>');
              headerRow.append('<th>Year</th>');
              headersDataPoints.forEach(header => {
                  headerRow.append(`<th>${header}</th>`);
              });
              dataPointsTableHeader.append(headerRow);
  
              cityDataPoints.forEach(row => {
                  const rowElement = $('<tr></tr>');
                  rowElement.append(`<td>${row.year}</td>`);
  
                  headersDataPoints.forEach(header => {
                      rowElement.append(`<td>${row[header] || 'N/A'}</td>`);
                  });
  
                  dataPointsTableBody.append(rowElement);
              });
          } else {
              dataPointsTableBody.append('<tr><td colspan="100%">No data available for this city.</td></tr>');
          }
      }
  
      loadAllCSVs();
  });
  </script>
  <script>
    $(document).ready(function () {
      let futureData = []; // Global array to hold combined CSV data
      let loadCount = 0;
      
      // Define raw GitHub CSV URLs for each future year (update these URLs)
      const predictedUrls = {
        "2023": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/Predicted_Metrics_2023-2026%20%20-%202023.csv",
        "2024": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/Predicted_Metrics_2023-2026%20%20-%202024.csv",
        "2025": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/Predicted_Metrics_2023-2026%20%20-%202025.csv",
        "2026": "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/Predicted_Metrics_2023-2026%20%20-%202026.csv"
      };
      
      const years = Object.keys(predictedUrls);
      
      // Load each CSV and add a "Year" property to each row
      years.forEach(function (year) {
        Papa.parse(predictedUrls[year], {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            if (results.data && results.data.length > 0) {
              results.data.forEach(function (row) {
                row.Year = year; // Tag each row with its year
                futureData.push(row);
              });
            }
            loadCount++;
            if (loadCount === years.length) {
              console.log("All future CSVs loaded:", futureData);
              populateFutureCityDropdowns(futureData);
            }
          },
          error: function (error) {
            console.error("Error loading CSV for " + year + ":", error);
            loadCount++;
            if (loadCount === years.length) {
              populateFutureCityDropdowns(futureData);
            }
          }
        });
      });
      
      // Group the future data by city.
      // The resulting structure is: { "City Name": { "2023": {...}, "2024": {...}, ... } }
      function buildCityData(data) {
        const cityData = {};
        data.forEach(function (row) {
          const city = row.CITY ? row.CITY.trim() : "";
          const year = row.Year ? row.Year.trim() : "";
          if (city) {
            if (!cityData[city]) {
              cityData[city] = {};
            }
            cityData[city][year] = row;
          }
        });
        return cityData;
      }
      
      // Populate the dropdown menus with unique city names
      function populateFutureCityDropdowns(data) {
        const cityData = buildCityData(data);
        const cities = Object.keys(cityData).sort();
        const dropdown1 = $('#futureCity1Dropdown');
        const dropdown2 = $('#futureCity2Dropdown');
        dropdown1.empty().append('<option value="">Select City 1</option>');
        dropdown2.empty().append('<option value="">Select City 2</option>');
        
        if (cities.length === 0) {
          console.warn("No cities found in future data.");
        }
        
        cities.forEach(function (city) {
          dropdown1.append(`<option value="${city}">${city}</option>`);
          dropdown2.append(`<option value="${city}">${city}</option>`);
        });
      }
      
      // Build the comparison table for two selected cities
      function buildFutureComparisonTable(cityData, city1, city2) {
        const yearsToDisplay = ["2023", "2024", "2025", "2026"];
        
        // Determine the list of metrics by using the keys from one of the city's data for one year.
        // Exclude "CITY" and "Year" from the metric list.
        let metrics = [];
        if (cityData[city1] && cityData[city1]["2023"]) {
          metrics = Object.keys(cityData[city1]["2023"]).filter(key => key !== "CITY" && key !== "Year");
        }
        
        // Build header rows: first row for city names and second for years.
        let headerHtml = "<tr><th rowspan='2'>Metric</th>";
        headerHtml += `<th colspan='${yearsToDisplay.length}'>${city1}</th><th colspan='${yearsToDisplay.length}'>${city2}</th></tr>`;
        headerHtml += "<tr>";
        yearsToDisplay.forEach(year => { headerHtml += `<th>${year}</th>`; });
        yearsToDisplay.forEach(year => { headerHtml += `<th>${year}</th>`; });
        headerHtml += "</tr>";
        
        // Build the table body: each row corresponds to one metric.
        let bodyHtml = "";
        metrics.forEach(metric => {
          bodyHtml += "<tr>";
          bodyHtml += `<td>${metric}</td>`;
          
          // Values for city1 across the years
          yearsToDisplay.forEach(year => {
            const val = cityData[city1][year] ? cityData[city1][year][metric] : "N/A";
            bodyHtml += `<td>${val || "N/A"}</td>`;
          });
          
          // Values for city2 across the years
          yearsToDisplay.forEach(year => {
            const val = cityData[city2][year] ? cityData[city2][year][metric] : "N/A";
            bodyHtml += `<td>${val || "N/A"}</td>`;
          });
          bodyHtml += "</tr>";
        });
        
        $('#futureComparisonTableHeader').html(headerHtml);
        $('#futureComparisonTableBody').html(bodyHtml);
      }
      
      // When the user selects a city from either dropdown, build the comparison table if both are selected.
      $('#futureCity1Dropdown, #futureCity2Dropdown').on('change', function () {
        if (!futureData.length) return;
        const cityData = buildCityData(futureData);
        const city1 = $('#futureCity1Dropdown').val();
        const city2 = $('#futureCity2Dropdown').val();
        if (city1 && city2) {
          buildFutureComparisonTable(cityData, city1, city2);
        }
      });
    });
    </script>
   <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
   <!-- DataTables JS -->
   <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
   <!-- PapaParse for CSV parsing -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
   <script>
$(document).ready(function () {
    // Data URLs
    const sheet2CsvUrl       = "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/city_metrics_as_percentages_of_golden_city%20-%20Sheet2.csv";
    const goldenCityCsvUrl   = "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/city_metrics_as_percentages_of_golden_city%20-%20city_metrics_as_percentages_of_golden_city.csv.csv";
    const expendituresCsvUrl = "https://raw.githubusercontent.com/yodieland/csv-data-host/refs/heads/main/expenditures%20-%20Sheet1.csv";

    // DataTables + data arrays
    let sheet2Table, rawDataTable, percentageDataTable, placemakingTable;
    let sheet2Data = [], metricsData = [], expendituresData = [];
    let sheet2Cities = [], goldenCities = [];
    let customCityData = {};
    const customCityName = "Custom City (Enter Your Data)";

    // ——— Helper to strip "$", commas, etc. and return a float or null
    function toNum(v) {
        if (typeof v === "number") return v;
        const n = parseFloat(String(v).replace(/[^0-9.\-]+/g, ""));
        return isNaN(n) ? null : n;
    }

    // ======================
    // CORE DATA FUNCTIONS
    // ======================
    function loadCSV(url, cacheKey, retries = 3, delay = 1000) {
        return new Promise((resolve, reject) => {
            const attempt = (n) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (res) => {
                        if (res.errors.length && n > 0) return setTimeout(() => attempt(n - 1), delay);
                        if (res.errors.length) {
                            const cached = localStorage.getItem(cacheKey);
                            return cached ? resolve(JSON.parse(cached)) : reject(res.errors);
                        }
                        localStorage.setItem(cacheKey, JSON.stringify(res.data));
                        localStorage.setItem(`${cacheKey}_ts`, Date.now());
                        resolve(res.data);
                    },
                    error: () => n > 0 ? setTimeout(() => attempt(n - 1), delay) : reject("CSV load failed")
                });
            };
            attempt(retries);
        });
    }

    async function loadAllData() {
        showLoading(true);
        disableDropdowns(true);
        try {
            const [s2, md, ed] = await Promise.all([
                loadCSV(sheet2CsvUrl, "cachedSheet2Data"),
                loadCSV(goldenCityCsvUrl, "cachedMetricsData"),
                loadCSV(expendituresCsvUrl, "cachedExpendituresData")
            ]);
            sheet2Data = s2;
            metricsData = md;
            expendituresData = ed;

            sheet2Cities  = Array.from(new Set(sheet2Data.map(r => r.City))).sort();
            goldenCities  = Array.from(new Set(metricsData.map(r => r.City)))
                                  .filter(c => c !== "Golden City (Average)")
                                  .sort();

            populateDropdowns();
            updateAllTables();
            updateDataFreshness();
            showToast("Data loaded successfully", "success");
        } catch (err) {
            console.error(err);
            showToast("Error loading data; using cache if available", "error");
        } finally {
            disableDropdowns(false);
            showLoading(false);
        }
    }

    function disableDropdowns(state) {
        ["#sheet2Select", "#citySelect1", "#citySelect2", "#citySelect3"]
          .forEach(sel => $(sel).prop("disabled", state));
    }

    // ======================
    // TABLE SETUP
    // ======================
    function initializeTables() {
        const opts = { paging: false, searching: false, info: false, scrollY: "300px", scrollCollapse: true };
        sheet2Table = $("#sheet2Table").DataTable({ ...opts, columns: [
            { title: "METRIC", data: "Metric" },
            { title: "VALUE", data: "Value" }
        ], createdRow: (row, d) => {
            if (["Expenditure per Person","Revenue per Person"].includes(d.Metric))
                $(row).addClass("priority-row");
        }});
        rawDataTable = $("#rawDataTable").DataTable({ ...opts, columns: [
            { title: "BUDGET ITEM", data: "Metric" },
            { title: "VALUE", data: "Value" }
        ], createdRow: (row, d) => {
            if (["Expenditure per Person","Revenue per Person"].includes(d.Metric))
                $(row).addClass("priority-row");
        }});
        percentageDataTable = $("#percentageDataTable").DataTable({ ...opts, columns: [
            { title: "BUDGET ITEM", data: "Metric" },
            { title: "Insights Percentage", data: "Percentage" }
        ]});
        placemakingTable = $("#placemakingTable").DataTable({ ...opts, columns: [
            { title: "BUDGET EXPENDITURES", data: "Metric" },
            { title: "SELECTED CITY", data: "SelectedCityValue" },
            { title: "REFERENCE CITY", data: "GoldenCityValue" },
            { title: "Placemeking Insights", data: "Percentage" }
        ], createdRow: (row, d) => {
            if (["Expenditure per Person","Revenue per Person"].includes(d.Metric))
                $(row).addClass("priority-row");
        }});
    }

    // ======================
    // DROPDOWNS
    // ======================
    function populateDropdown(id, list) {
        const dd = $(`#${id}`).empty();
        dd.append(`<option disabled selected>Select a city...</option>`);
        dd.append(`<option>${customCityName}</option>`);
        list.forEach(c => dd.append(`<option>${c}</option>`));
    }
    function populateDropdowns() {
        populateDropdown("sheet2Select", sheet2Cities);
        populateDropdown("citySelect1", goldenCities);
        populateDropdown("citySelect2", goldenCities);
        populateDropdown("citySelect3", goldenCities);
    }

    // ======================
    // UPDATERS
    // ======================
    function updateAllTables() {
        updateSheet2Table();
        updateRawDataTable();
        updatePercentageDataTable();
        updatePlacemakingTable();
    }

    function updateSheet2Table() {
        const city = $("#sheet2Select").val();
        if (!city || city === customCityName) return;
        const row = sheet2Data.find(r => r.City === city) || {};
        const data = Object.entries(row)
            .filter(([k,v]) => k!=="City" && v!=null)
            .map(([Metric,Value]) => ({ Metric, Value }));
        sheet2Table.clear().rows.add(data).draw();
    }

    function updateRawDataTable() {
        const city = $("#citySelect1").val();
        if (!city || city === customCityName) return;
        const row = metricsData.find(r => r.City === city) || {};
        const data = Object.entries(row)
            .filter(([k,v]) => k!=="City" && v!=null)
            .map(([Metric,Value]) => ({ Metric, Value }));
        rawDataTable.clear().rows.add(data).draw();
    }

    function updatePercentageDataTable() {
        const city = $("#citySelect2").val();
        if (!city) return;
        if (city === customCityName && !Object.keys(customCityData).length) {
            $('#customDataModal').modal('show');
            return;
        }

        // Merge all three: expenditures, sheet2 & metrics
        const gExp    = expendituresData.find(r=>r.City==="Golden City (Average)")||{};
        const g2      = sheet2Data.find(r=>r.City==="Golden City (Average)")||{};
        const gMet    = metricsData.find(r=>r.City==="Golden City (Average)")||{};
        const golden  = {...gExp, ...g2, ...gMet};

        const sExp    = expendituresData.find(r=>r.City===city)||{};
        const s2      = sheet2Data.find(r=>r.City===city)||{};
        const sMet    = metricsData.find(r=>r.City===city)||{};
        const selected= {...sExp, ...s2, ...sMet};

        const rows = Object.keys(golden)
            .filter(k=>k!=="City")
            .map(Metric=>{
                const gVal = toNum(golden[Metric]);
                const sVal = toNum(selected[Metric]);
                let Percentage = "N/A";
                if (gVal!=null && sVal!=null && gVal!==0) {
                    Percentage = ((sVal/gVal)*100).toFixed(2) + "%";
                }
                return { Metric, Percentage };
            })
            .sort((a,b)=>a.Metric.localeCompare(b.Metric));

        percentageDataTable.clear().rows.add(rows).draw();
    }

    function updatePlacemakingTable() {
        const city = $("#citySelect3").val();
        if (!city) return;
        if (city===customCityName && !Object.keys(customCityData).length) {
            $('#customDataModal').modal('show');
            return;
        }

        const g = expendituresData.find(r=>r.City==="Golden City (Average)")||{};
        const s = expendituresData.find(r=>r.City===city)||{};
        const list = [
            "Public Safety per Person","Public Works per Person",
            "Parks & Rec. per Person","Comm. & Econ. Dev. per Person",
            "Public Health per Person","Public Safety","Public Works",
            "Parks & Rec.","Comm. & Econ. Dev.","Public Health"
        ];

        const rows = list.map(Metric=>{
            const gVal = toNum(g[Metric]);
            const sVal = toNum(s[Metric]);
            let Percentage = "N/A";
            if (gVal!=null && sVal!=null && gVal!==0) {
                Percentage = ((sVal/gVal)*100).toFixed(2) + "%";
            }
            return {
                Metric,
                SelectedCityValue: formatNumber(sVal),
                GoldenCityValue:  formatNumber(gVal),
                Percentage
            };
        });

        placemakingTable.clear().rows.add(rows).draw();
    }

    // ======================
    // CUSTOM MODAL + UTILS
    // ======================
    function initCustomDataModal() {
        /* … your existing modal HTML … */
        $('#saveCustomData').click(()=>{
            customCityData = {};
            $('#customDataForm').serializeArray().forEach(({name,value})=>{
                if (value!=="") customCityData[name] = parseFloat(value);
            });
            customCityData.City = customCityName;
            $('#customDataModal').modal('hide');
            updateAllTables();
        });
    }
    function formatNumber(v){ return typeof v==="number" ? v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : "N/A"; }
    function showLoading(on){ on ? $('#loadingOverlay').show() : $('#loadingOverlay').hide(); }
    function updateDataFreshness(){
        const ts = ['sheet2Data','metricsData','expendituresData']
            .map(k=>localStorage.getItem(k+'_ts')).filter(Boolean).map(Number);
        if(ts.length){
            const d = new Date(Math.max(...ts));
            $('#dataFreshness').text(`Data updated: ${d.toLocaleString()}`).show();
        }
    }
    function showToast(msg,cls){ $(`<div class="toast toast-${cls}">${msg}</div>`)
        .appendTo('#toastContainer').fadeIn().delay(3000).fadeOut(()=>$(this).remove());
    }

    // ======================
    // INIT
    // ======================
    initializeTables();
    initCustomDataModal();
    $('#sheet2Select,#citySelect1,#citySelect2,#citySelect3').on('change',updateAllTables);
    $('#refreshData').click(loadAllData);
    loadAllData();
});

</script>
